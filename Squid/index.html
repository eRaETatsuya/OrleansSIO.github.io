<!doctype html>
<html lang="en">

<head>
        <title>-Squid - Doc Orléans</title>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        
        
        

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="../assets/css/bootstrap.min.css">
        <link rel="stylesheet" href="../assets/css/dracula-ui.css">
        <link rel="stylesheet" href="../assets/css/mkdocs.css">

        
            <link  rel="icon" type="image/x-icon" href="../assets/images/favicon.png">
        

</head>

<body class="drac-bg-black-secondary drac-text-grey-ternary drac-text drac-scrollbar-purple">

    <main class="d-flex">

        <!-- block sidebar -->
            <nav id="sidebar" class="sidebar drac-bg-black">
    <div class="custom-menu">
        <button type="button" id="sidebarCollapse" class="btn btn-primary">
            <i class="fa fa-bars"></i>
            <span class="sr-only">Menu</span>
        </button>
    </div>

    <div class="p-4">
        

        <div class="drac-text-center">
            
                <span class="drac-text drac-line-height drac-text-white">Doc Orléans</span>
            
        </div>

        <div class="drac-box flex-column">
            <ul class="dot-ul">
                <li><div class="dot-li drac-bg-cyan"></div></li>
                <li><div class="dot-li drac-bg-green"></div></li>
                <li><div class="dot-li drac-bg-orange"></div></li>
                <li><div class="dot-li drac-bg-pink"></div></li>
                <li><div class="dot-li drac-bg-purple"></div></li>
                <li><div class="dot-li drac-bg-red"></div></li>
                <li><div class="dot-li drac-bg-yellow"></div></li>
            </ul>
        </div>

        <hr class="drac-divider" />

        <!-- block menu -->
        <ul class="mb-5 drac-list drac-list-none">
            
            <li class="drac-box">
                <a href=".."
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Home
                </a>
            </li>
            <li class="drac-box">
                <a href=".."
                    class=" active 
                    drac-anchor btn-toggle d-inline-flex align-items-center border-0 drac-text-purple--hover collapsed"
                    data-bs-toggle="collapse" data-bs-target="#configuration-collapse" aria-expanded="false">
                    Configuration
                </a>
                <div class="collapse" id="configuration-collapse">
                    <ul class="mb-5 drac-list drac-list-none">
                            
    <li class="drac-box-ternary">
        <a href="../plan_adressage/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            -Plan d'adressage
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="#" class="
            drac-anchor-secondary btn-toggle d-inline-flex align-items-center border-0 drac-text-purple--hover collapsed"
            data-bs-toggle="collapse" data-bs-target="#schéma-⤵️-collapse" aria-expanded="false">
            Schéma ⤵️
        </a>

        <div class="collapse" id="schéma-⤵️-collapse">
            <ul class="mb-5 drac-list drac-list-none">
                    
    <li class="drac-box-ternary">
        <a href="../schema/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            -Infrastructure
        </a>
    </li>
                    
    <li class="drac-box-ternary">
        <a href="../ports/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            -Attribution des Ports
        </a>
    </li>
            </ul>
        </div>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../switch/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            -Switch
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../pfsense/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            -PFsense
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../serveur/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            -Serveur
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="#" class="
            drac-anchor-secondary btn-toggle d-inline-flex align-items-center border-0 drac-text-purple--hover collapsed"
            data-bs-toggle="collapse" data-bs-target="#routeur-⤵️-collapse" aria-expanded="false">
            Routeur ⤵️
        </a>

        <div class="collapse" id="routeur-⤵️-collapse">
            <ul class="mb-5 drac-list drac-list-none">
                    
    <li class="drac-box-ternary">
        <a href="../routeurs/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            Configuration
        </a>
    </li>
                    
    <li class="drac-box-ternary">
        <a href="../NAT/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            NAT
        </a>
    </li>
            </ul>
        </div>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../http_serv/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            -Serveur http(s)
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../Stormshield/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            -Stormshield
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../resolveur_dns/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            -Resolveur
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../reverse_proxy/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            -Reverse Proxy
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../serveur_dns/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            -Serveur DNS
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../serveur_docker/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            -Serveur Docker
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../VPN_WireGuard/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            -Serveur VPN
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../Hmail/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            -Serveur Hmail
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="../Guac/"
            class="
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            -Guacamole
        </a>
    </li>
                            
    <li class="drac-box-ternary">
        <a href="./"
            class=" active 
            drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
            -Squid
        </a>
    </li>
                    </ul>
                </div>
            </li>
        </ul>
        <!-- endblock -->
    </div>
</nav>
        <!-- endblock -->

        <nav class="divider drac-bg-purple-cyan"></nav>

        <div class="content">
            <!-- block header -->
                <header>
    <nav class="navbar navbar-expand-xl drac-bg-purple"">
        <div class="container-fluid">

            <!-- <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsMenu"
                aria-controls="navbarsMenu" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button> -->

            <div class="collapse navbar-collapse flex-column ml-auto" id="navbarsMenu">
                <ul class="navbar-nav">

                    <!-- block preview -->
                    <li class="nav-item">
                            
        <div class="container">
            <div class="row row-preview">
                <div class="col">
                    <a href="../Guac/"
                        class="btn-preview drac-btn drac-btn-outline drac-text-white drac-text-cyan-green--hover">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </div>
                <div class="col">
                    <a 
                        class="btn-preview drac-btn drac-text-white--hover disabled" style="padding-left: 3%;">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
                    </li>
                    <!--  endblock -->

                    <!-- block search -->
                    <li class="nav-item">
                    </li>
                    <!--  endblock -->

                    <!-- block source -->
                    <li class="nav-item">
                        
                    </li>
                    <!--  endblock -->

                </ul>
            </div>

        </div>
    </nav>
</header>
            <!-- endblock -->

            <!-- block content -->
                <section class="p-md-5 section-content">
    <article>
        <p><h1 id="installation-squidsquidguard">Installation Squid/SquidGuard</h1>
<h2 id="1-constatation">1. Constatation</h2>
<h3 id="11-besoin">1.1 Besoin</h3>
<p>Pour installer le proxy nous avons besoins de créer une machine virtuelle Debian sur Nutanix</p>
<h3 id="12-objectifs">1.2 Objectifs</h3>
<p>À partir d’un navigateur se connecter à <a href="http://dsi.ut-capitole.fr/hidden/test">http://dsi.ut-capitole.fr/hidden/test</a> (le test ne marcherait pas bien en HTTPS et il faut que l'ip du proxy soit recensé dans le navigateur Firefox) On constate alors l’information ”User-Agent” qui indique le nom et la version du navigateur et le nom et la version de l’OS. Cette information, utile, va nous donner l’occasion de voir ce qui peut être fait par un relai applicatif.</p>
<h2 id="2-squid">2. Squid</h2>
<h3 id="21-installation">2.1 Installation</h3>
<p>L’installation du relai proxy squid est assez simple (nous supposons utiliser squid3, mais dans la toute dernière Debian, c’est squid 4, qui est dénommé ”squid” tout court).</p>
<pre><code class="language-bash">apt-get install squid
</code></pre>
<p>Après l'installation, un <code>squid.conf</code> s'est crée, remplit de commentaire, il faut supprimer l'inutile :</p>
<pre><code class="language-bash">cd /etc/squid3
# On cree une copie sous le nom squid.conf.distrib
cp squid.conf squid.conf.distrib
# On enleve les commentaires, puis on ne prend que les lignes avec 2 caracteres
cat squid.conf|grep -Pv '^#'|grep -P '..' &gt; squid.conf.new
cp squid.conf.new squid.conf
</code></pre>
<p>On peut alors lancer le squid</p>
<pre><code class="language-bash">service squid start
</code></pre>
<p>Dans le cas où l’on utilise la machine virtuelle, il sera nécessaire d’autoriser le réseau, où se trouve la machine
cliente (la machine physique), à utiliser le squid local. Dans le fichier squid.conf on va donc ajouter une définition
d’ACL, puis utiliser cette définition. Il sera important de bien choisir l’ordre dans lequel on va placer les acl et
leur utilisation.</p>
<pre><code class="language-bash">acl localclient src 172.16.0.0/12 #Cette ACL est déjà créée mais dans l'installation de squid l'ACL a pour nom localnet moi je l'ai renommée localclient (en laissant le src)
...
http_access allow localclient #Il faut créer cette ACL
</code></pre>
<h3 id="22-verification">2.2 Vérification</h3>
<p>Pour vérifier que le fichier est conforme et sans erreur:</p>
<pre><code class="language-bash">squid -k check
</code></pre>
<h3 id="23-utilisation">2.3 Utilisation</h3>
<p>Se diriger vers Firefox, puis dans les paramètres, chercher proxy, puis recenser l'ip et le port du proxy:
Le notre c'est 172.28.98.253:3128 et cliquer sur <code>Utiliser également ce proxy pour HTTPS</code></p>
<h3 id="3-installation-de-squidguard">3 Installation de SquidGuard</h3>
<p>Squid ne peut bloquer que des URLs une par une, ce qui est long, donc on va installer SquidGuard</p>
<pre><code class="language-bash">apt-get install squidguard
</code></pre>
<p>Une fois ceci fait, on signale à squid d’utiliser squidGuard. Pour cela, on modifie /etc/squid3/squid.conf</p>
<pre><code class="language-bash">url_rewrite_program /usr/bin/squidGuard
</code></pre>
<h3 id="32-configuration-du-logiciel">3.2 Configuration du logiciel</h3>
<p>La configuration doit se faire avant l’installation des bases de données. Le fichier de configuration est, en général,
/etc/squidGuard/squidGuard.conf</p>
<h3 id="33-les-bases-de-filtrage">3.3 Les bases de filtrage</h3>
<p>On rapatrie une base de filtrage et on l’installe</p>
<pre><code class="language-bash">cd /var/lib/squidguard/db
wget http://dsi.ut-capitole.fr/blacklists/download/blacklists.tar.gz
# On decompacte, un repertoire blacklists est alors cree
tar zxvf blacklists.tar.gz
# On cree un lien symbolique pour garder la notion de dest
ln -s blacklists dest
# Pour accelerer le traitement (mais en reduisant considerablement le nombre de domaines filtres)
cd dest/adult
cp domains domains.originel
echo &quot;playboy.com&quot; &gt;domains
echo &quot;sex.com&quot; &gt;&gt;domains
echo &quot;lesitequevousvoulezajouter.com&quot; &gt;&gt; domains
chown proxy:proxy domains
</code></pre>
<p>La structure des fichiers textes contenant la liste est créée. Squidguard peut fonctionner tel quel (il recompilera les bases en m´emoire au démarrage), mais cela ralentira considérablement tout démarrage ou redémarrage.
Il faut donc créer (compiler) les bases de donn´ees avant le lancement.
Il faudra prendre la précaution d’arrêter le squid avant, si on veut que la compilation soit rapide.</p>
<pre><code class="language-bash">mv database db
service squid stop
/usr/bin/squidGuard -P -d -b -C all
chown -R proxy:proxy /var/lib/squidguard/db
service squid start
</code></pre>
<p>Cette commande va compiler les bases de donn´ees qui sont utilis´ees dans le squidGuard.conf. Comme la
commande a ´et´e faite par root, les fichiers domains.db et urls.db lui appartiennent, il faut changer le propri´etaire.
On peut alors relancer le squid</p></p>
    </article>
</section>
            <!-- endblock -->

            <!-- block footer -->
                <footer>
    <div class="d-flex flex-sm-row justify-content-between py-2 border-top drac-text-black drac-bg-cyan-green">
        <a href="https://github.com/dracula/mkdocs" target="_blank" style="padding-left: 1%;"
            class="footer-text drac-anchor drac-text-black drac-text-purple--hover">
            Made with Dracula Theme for MkDocs
        </a>
    </div>
</footer>
            <!-- endblock -->
        </div>

    </main>

        <script>var base_url = '..';</script>
        <script src="../assets/js/jquery-3.3.1.slim.min.js""></script>
        <script src="../assets/js/bootstrap.bundle.min.js""></script>
        <script src="../assets/js/mkdocs.js""></script>

</body>

</html>
